# ------------------------------------------------------------------------------------
#  Test Results Validation (Reusable Workflow) (GoFortress)
#
#  Purpose: Validate and aggregate test results from all test workflows using
#  native CI mode output (.mage-x/ci-results.jsonl).
#
#  This workflow handles:
#    - Downloading CI results artifacts from test workflows
#    - Validating test exit codes and failure counts
#    - Aggregating failures across matrix jobs
#    - Creating comprehensive validation reports
#
#  CI Mode Integration: magex CI mode produces .mage-x/ci-results.jsonl which
#  contains structured failure data with built-in deduplication.
#
#  Maintainer: @mrz1836
#
# ------------------------------------------------------------------------------------

name: GoFortress (Test Validation)

on:
  workflow_call:
    inputs:
      env-json:
        description: "JSON string of environment variables"
        required: true
        type: string
      primary-runner:
        description: "Primary runner OS"
        required: true
        type: string
      fuzz-testing-enabled:
        description: "Whether fuzz testing is enabled"
        required: true
        type: string

# Security: Restrictive default permissions with job-level overrides for least privilege access
permissions:
  contents: read
  actions: read # Required for artifact downloads

jobs:
  # ----------------------------------------------------------------------------------
  # Validate Test Results
  # ----------------------------------------------------------------------------------
  validate-test-results:
    name: ðŸ” Validate Test Results
    if: always() # Always run to check results even if jobs continued on error
    permissions:
      contents: read # Read repository content for validation
      actions: read # Read workflow artifacts for download
    runs-on: ${{ inputs.primary-runner }}

    steps:
      # --------------------------------------------------------------------
      # Checkout code (required for local actions)
      # --------------------------------------------------------------------
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # --------------------------------------------------------------------
      # Parse environment variables
      # --------------------------------------------------------------------
      - name: ðŸ”§ Parse environment variables
        uses: ./.github/actions/parse-env
        with:
          env-json: ${{ inputs.env-json }}

      # --------------------------------------------------------------------
      # Download CI results from test matrix
      # --------------------------------------------------------------------
      - name: ðŸ“¥ Download CI results
        uses: ./.github/actions/download-artifact-resilient
        with:
          pattern: "ci-results-*"
          path: ci-results/
          merge-multiple: true
          max-retries: ${{ env.ARTIFACT_DOWNLOAD_RETRIES }}
          retry-delay: ${{ env.ARTIFACT_DOWNLOAD_RETRY_DELAY }}
          timeout: ${{ env.ARTIFACT_DOWNLOAD_TIMEOUT }}
          continue-on-error: ${{ env.ARTIFACT_DOWNLOAD_CONTINUE_ON_ERROR }}

      # --------------------------------------------------------------------
      # Download fuzz test results if enabled
      # --------------------------------------------------------------------
      - name: ðŸ“¥ Download fuzz test results
        if: inputs.fuzz-testing-enabled == 'true'
        uses: ./.github/actions/download-artifact-resilient
        with:
          pattern: "test-results-fuzz-*"
          path: ci-results/
          merge-multiple: true
          max-retries: ${{ env.ARTIFACT_DOWNLOAD_RETRIES }}
          retry-delay: ${{ env.ARTIFACT_DOWNLOAD_RETRY_DELAY }}
          timeout: ${{ env.ARTIFACT_DOWNLOAD_TIMEOUT }}
          continue-on-error: ${{ env.ARTIFACT_DOWNLOAD_CONTINUE_ON_ERROR }}

      # --------------------------------------------------------------------
      # Validate test results from CI mode JSONL output
      # --------------------------------------------------------------------
      - name: ðŸ” Validate test results
        run: |
          echo "ðŸ” Validating test results from CI mode output..."
          VALIDATION_FAILED=false
          TOTAL_FAILURES=0
          TOTAL_TESTS=0

          # Find all CI results files
          echo "ðŸ“‹ Looking for CI results files..."
          find ci-results/ -name "ci-results.jsonl" -o -name "*.jsonl" 2>/dev/null | head -20

          # Process each CI results file
          if compgen -G "ci-results/**/*.jsonl" >/dev/null 2>&1 || compgen -G "ci-results/*.jsonl" >/dev/null 2>&1; then
            echo "âœ… Found CI results JSONL files"

            for jsonl_file in $(find ci-results/ -name "*.jsonl" 2>/dev/null); do
              echo ""
              echo "ðŸ“„ Processing: $jsonl_file"

              # Extract summary line (type: summary)
              SUMMARY=$(grep '"type":"summary"' "$jsonl_file" 2>/dev/null | head -1 || echo "")

              if [[ -n "$SUMMARY" ]]; then
                # Parse summary data
                STATUS=$(echo "$SUMMARY" | jq -r '.summary.status // "unknown"')
                PASSED=$(echo "$SUMMARY" | jq -r '.summary.passed // 0')
                FAILED=$(echo "$SUMMARY" | jq -r '.summary.failed // 0')
                TOTAL=$(echo "$SUMMARY" | jq -r '.summary.total // 0')
                DURATION=$(echo "$SUMMARY" | jq -r '.summary.duration // "unknown"')

                echo "  â€¢ Status: $STATUS"
                echo "  â€¢ Passed: $PASSED"
                echo "  â€¢ Failed: $FAILED"
                echo "  â€¢ Total: $TOTAL"
                echo "  â€¢ Duration: $DURATION"

                TOTAL_TESTS=$((TOTAL_TESTS + TOTAL))

                if [[ "$STATUS" == "failed" ]] || [[ "$FAILED" -gt 0 ]]; then
                  VALIDATION_FAILED=true
                  TOTAL_FAILURES=$((TOTAL_FAILURES + FAILED))

                  # Extract failure details
                  echo ""
                  echo "  ðŸš¨ Failures in this file:"
                  grep '"type":"failure"' "$jsonl_file" 2>/dev/null | while read -r line; do
                    TEST=$(echo "$line" | jq -r '.failure.test // "unknown"')
                    PKG=$(echo "$line" | jq -r '.failure.package // "unknown"' | sed 's|.*/||')
                    FILE=$(echo "$line" | jq -r '.failure.file // ""')
                    LINE=$(echo "$line" | jq -r '.failure.line // ""')

                    if [[ -n "$FILE" && -n "$LINE" ]]; then
                      echo "    âŒ $TEST ($PKG) at $FILE:$LINE"
                    else
                      echo "    âŒ $TEST ($PKG)"
                    fi
                  done | head -20
                fi
              else
                echo "  âš ï¸ No summary found in JSONL file"

                # Try to count failures directly
                FAILURE_COUNT=$(grep -c '"type":"failure"' "$jsonl_file" 2>/dev/null || echo "0")
                if [[ "$FAILURE_COUNT" -gt 0 ]]; then
                  echo "  â€¢ Found $FAILURE_COUNT failure entries"
                  VALIDATION_FAILED=true
                  TOTAL_FAILURES=$((TOTAL_FAILURES + FAILURE_COUNT))
                fi
              fi
            done
          else
            echo "âš ï¸ No JSONL files found - checking for test-output.log files..."

            # Fallback: check test-output.log files for exit codes
            for log_file in $(find ci-results/ -name "test-output.log" 2>/dev/null); do
              echo "ðŸ“„ Checking: $log_file"

              # Look for FAIL indicators
              if grep -q "^FAIL" "$log_file" 2>/dev/null || grep -q "--- FAIL:" "$log_file" 2>/dev/null; then
                echo "  âŒ Found test failures in log file"
                VALIDATION_FAILED=true
                FAIL_COUNT=$(grep -c "^--- FAIL:" "$log_file" 2>/dev/null || echo "1")
                TOTAL_FAILURES=$((TOTAL_FAILURES + FAIL_COUNT))
              fi
            done
          fi

          # Final validation result
          echo ""
          echo "ðŸ Validation Summary:"
          echo "  â€¢ Total Tests: $TOTAL_TESTS"
          echo "  â€¢ Total Failures: $TOTAL_FAILURES"
          echo "  â€¢ Validation Status: $(if [[ "$VALIDATION_FAILED" == "true" ]]; then echo "FAILED"; else echo "PASSED"; fi)"

          if [[ "$VALIDATION_FAILED" == "true" ]]; then
            echo ""
            echo "âŒ Test validation failed - $TOTAL_FAILURES failure(s) detected"
            echo "::error title=Test Validation Failed::$TOTAL_FAILURES test failure(s) detected. Check the CI results above for details."
            exit 1
          else
            echo ""
            echo "âœ… All tests passed validation"
          fi

      # --------------------------------------------------------------------
      # Create validation summary for GitHub UI
      # --------------------------------------------------------------------
      - name: ðŸ“Š Create validation summary
        if: always()
        run: |
          echo "## ðŸ” Test Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count artifacts
          MATRIX_JOBS=$(find ci-results/ -name "*.jsonl" 2>/dev/null | wc -l || echo "0")
          echo "- **Matrix Jobs Validated**: $MATRIX_JOBS" >> $GITHUB_STEP_SUMMARY

          # Aggregate results from JSONL files
          TOTAL_PASSED=0
          TOTAL_FAILED=0
          TOTAL_TESTS=0

          for jsonl_file in $(find ci-results/ -name "*.jsonl" 2>/dev/null); do
            SUMMARY=$(grep '"type":"summary"' "$jsonl_file" 2>/dev/null | head -1 || echo "")
            if [[ -n "$SUMMARY" ]]; then
              PASSED=$(echo "$SUMMARY" | jq -r '.summary.passed // 0')
              FAILED=$(echo "$SUMMARY" | jq -r '.summary.failed // 0')
              TOTAL=$(echo "$SUMMARY" | jq -r '.summary.total // 0')
              TOTAL_PASSED=$((TOTAL_PASSED + PASSED))
              TOTAL_FAILED=$((TOTAL_FAILED + FAILED))
              TOTAL_TESTS=$((TOTAL_TESTS + TOTAL))
            fi
          done

          echo "- **Total Tests**: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed**: $TOTAL_PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed**: $TOTAL_FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.fuzz-testing-enabled }}" == "true" ]]; then
            echo "- **Fuzz Testing**: Enabled" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Show per-job breakdown
          if [[ $MATRIX_JOBS -gt 0 ]]; then
            echo "### Test Matrix Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            for jsonl_file in $(find ci-results/ -name "*.jsonl" 2>/dev/null); do
              JOB_NAME=$(dirname "$jsonl_file" | xargs basename)
              SUMMARY=$(grep '"type":"summary"' "$jsonl_file" 2>/dev/null | head -1 || echo "")

              if [[ -n "$SUMMARY" ]]; then
                STATUS=$(echo "$SUMMARY" | jq -r '.summary.status // "unknown"')
                PASSED=$(echo "$SUMMARY" | jq -r '.summary.passed // 0')
                FAILED=$(echo "$SUMMARY" | jq -r '.summary.failed // 0')

                if [[ "$STATUS" == "passed" ]]; then
                  echo "- âœ… **$JOB_NAME**: $PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                else
                  echo "- âŒ **$JOB_NAME**: $FAILED failures" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
          fi

      # --------------------------------------------------------------------
      # Upload validation artifacts
      # --------------------------------------------------------------------
      - name: ðŸ“¤ Upload validation summary
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: validation-summary
          path: ci-results/
          retention-days: 1
          if-no-files-found: ignore
